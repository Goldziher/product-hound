name: Deploy

on:
    push:
        branches:
            - main
    workflow_dispatch:

env:
    AZURE_FUNCTIONAPP_PACKAGE_PATH: '.' # set this to the path to your web app project, defaults to the repository root
    NODE_VERSION: '20.x' # set this to the node version to use (supports 8.x, 10.x, 12.x)

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
            - name: Install PNPM
              uses: pnpm/action-setup@v3.0.0
              id: pnpm-install
              with:
                  version: 8
                  run_install: false
            - name: Setup PNPM Cache
              id: pnpm-cache
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
            - name: Load Cached Dependencies
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-
            - name: Install
              run: pnpm install
            - name: Build
              run: pnpm build
            - name: Prune
              run: pnpm prune --prod --no-optional
            - name: 'Deploy'
              uses: Azure/functions-action@v1
              id: fa
              with:
                  app-name: 'basemind'
                  slot-name: 'Production'
                  package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
                  publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_A7255E6476824DE98D260EF05A2F03EB }}
